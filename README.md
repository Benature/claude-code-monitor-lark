# Claude é™åˆ¶ç›‘æ§ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå…¨é¢çš„ Claude è´¦æˆ·å’Œ API ä½¿ç”¨æƒ…å†µç›‘æ§ç³»ç»Ÿï¼Œæ”¯æŒå®æ—¶çŠ¶æ€æ£€æŸ¥ã€æ™ºèƒ½é€šçŸ¥å’Œè¿œç¨‹æ§åˆ¶ã€‚

> **æ•°æ®æºä¾èµ–**: æœ¬é¡¹ç›®éœ€è¦é…åˆ [claude-relay-service](https://github.com/Wei-Shaw/claude-relay-service) ä½¿ç”¨ï¼Œè¯¥æœåŠ¡æä¾›Claudeè´¦æˆ·å’ŒAPIå¯†é’¥çš„æ•°æ®æ¥å£ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” åŒé‡ç›‘æ§
- **Claudeè´¦æˆ·ç›‘æ§**ï¼šæ£€æŸ¥è´¦æˆ·é™æµçŠ¶æ€ã€ä½¿ç”¨æƒ…å†µå’Œæ¢å¤æ—¶é—´
- **APIå¯†é’¥ç›‘æ§**ï¼šè·Ÿè¸ªAPIå¯†é’¥çš„ä½¿ç”¨ç»Ÿè®¡å’Œæ¶ˆè€—æƒ…å†µ

### ğŸ”§ æ™ºèƒ½æ¶æ„
- **å†…å­˜æ•°æ®æµ**ï¼šç»„ä»¶é—´é€šè¿‡å†…å­˜ç›´æ¥äº¤äº’ï¼Œæ— éœ€æ–‡ä»¶ä¾èµ–
- **å˜åŒ–æ£€æµ‹**ï¼šä»…åœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘é€é€šçŸ¥ï¼Œé¿å…åƒåœ¾ä¿¡æ¯
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„ç»„ä»¶åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

### ğŸ“± é£ä¹¦é›†æˆ
- **å¤šæ¨¡å¼æ”¯æŒ**ï¼šWebhookæ¨¡å¼å’Œåº”ç”¨æ¨¡å¼
- **äº¤äº’å¼å¡ç‰‡**ï¼šç¾è§‚çš„æ¶ˆæ¯å¡ç‰‡ï¼ŒåŒ…å«è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- **æ™ºèƒ½æŒ‰é’®**ï¼šæ”¯æŒURLè·³è½¬å’Œå›è°ƒä¸¤ç§æŒ‰é’®ç±»å‹
- **ChallengeéªŒè¯**ï¼šå®Œæ•´æ”¯æŒé£ä¹¦å›è°ƒéªŒè¯æœºåˆ¶

### ğŸŒ HTTP API
- **FastAPIæœåŠ¡å™¨**ï¼šæä¾›RESTful APIç”¨äºè¿œç¨‹æ§åˆ¶
- **å¤šç§è®¤è¯**ï¼šæ”¯æŒAPIå¯†é’¥è®¤è¯å’ŒHMACç­¾åéªŒè¯
- **ç®€å•è§¦å‘**ï¼šæ”¯æŒURLå‚æ•°éªŒè¯çš„å¿«é€Ÿè§¦å‘æ¥å£

### âš™ï¸ çµæ´»é…ç½®
- **YAMLé…ç½®**ï¼šç»“æ„åŒ–é…ç½®æ–‡ä»¶ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡
- **æ—¶åŒºæ”¯æŒ**ï¼šå¯é…ç½®æ—¶åŒºæ˜¾ç¤ºï¼ˆé»˜è®¤ï¼šAsia/Shanghaiï¼‰
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§é€šçŸ¥

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# ä½¿ç”¨Makefileï¼ˆæ¨èï¼‰
make install

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install -r requirements.txt
```

### 2. é…ç½®ç³»ç»Ÿ

å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
cp config.example.yaml config.yaml
# ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼Œé…ç½®APIç«¯ç‚¹ã€è®¤è¯ä¿¡æ¯å’Œé£ä¹¦é€šçŸ¥
```

ä¸»è¦é…ç½®é¡¹ï¼š
- **APIæ•°æ®æº**ï¼šé…ç½®Claudeè´¦æˆ·å’ŒAPIå¯†é’¥æ•°æ®ç«¯ç‚¹
- **é£ä¹¦é€šçŸ¥**ï¼šè®¾ç½®Webhook URLæˆ–åº”ç”¨æ¨¡å¼è®¤è¯
- **æœåŠ¡å™¨è®¾ç½®**ï¼šFastAPIæœåŠ¡å™¨ä¸»æœºã€ç«¯å£å’Œè®¤è¯é…ç½®

### 3. è¿è¡Œç›‘æ§

```bash
# ä½¿ç”¨Makefileè¿è¡Œï¼ˆæ¨èï¼‰
make run              # Claudeè´¦æˆ·ç›‘æ§
make run-api          # APIä½¿ç”¨æƒ…å†µç›‘æ§  
make run-server       # å¯åŠ¨HTTP APIæœåŠ¡å™¨

# æˆ–ç›´æ¥è¿è¡ŒPythonè„šæœ¬
python main.py        # Claudeè´¦æˆ·ç›‘æ§
python api_monitor.py # APIä½¿ç”¨æƒ…å†µç›‘æ§
python start_server.py # HTTP APIæœåŠ¡å™¨
```

## è¯¦ç»†ä½¿ç”¨æŒ‡å—

### Makefile å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# ä¸»è¦ç›‘æ§åŠŸèƒ½
make run              # Claudeè´¦æˆ·ç›‘æ§ï¼ˆæ¨èï¼‰
make run-api          # APIä½¿ç”¨æƒ…å†µç›‘æ§
make run-force        # å¼ºåˆ¶å‘é€Claudeè´¦æˆ·é€šçŸ¥
make run-api-force    # å¼ºåˆ¶å‘é€APIä½¿ç”¨é€šçŸ¥

# æœåŠ¡å™¨ç›¸å…³
make run-server       # å¯åŠ¨FastAPIæœåŠ¡å™¨
make run-dev          # å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
make server-dev       # å¼€å‘æœåŠ¡å™¨
make server-prod      # ç”Ÿäº§æœåŠ¡å™¨ï¼ˆå¤šè¿›ç¨‹ï¼‰

# å•ç‹¬ç»„ä»¶æµ‹è¯•
make scrape-accounts  # ä»…çˆ¬å–Claudeè´¦æˆ·æ•°æ®
make scrape-api       # ä»…çˆ¬å–APIä½¿ç”¨æ•°æ®
make check-limits     # ä»…æ£€æŸ¥é™æµçŠ¶æ€
make notify           # æµ‹è¯•é€šçŸ¥åŠŸèƒ½

# è¿œç¨‹è§¦å‘ï¼ˆéœ€è¦æœåŠ¡å™¨è¿è¡Œï¼‰
make trigger-accounts # è§¦å‘è´¦æˆ·ç›‘æ§
make trigger-api      # è§¦å‘APIç›‘æ§
make trigger-full     # è§¦å‘å®Œæ•´ç›‘æ§

# å¼€å‘ç›¸å…³
make test             # è¿è¡Œæµ‹è¯•
make lint             # ä»£ç æ£€æŸ¥
make format           # ä»£ç æ ¼å¼åŒ–
```

### å‘½ä»¤è¡Œå‚æ•°

æ‰€æœ‰ä¸»è¦è„šæœ¬éƒ½æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

```bash
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
python main.py --config custom_config.yaml
python api_monitor.py --config custom_config.yaml

# è·³è¿‡æ•°æ®çˆ¬å–ï¼Œä½¿ç”¨ç°æœ‰æ•°æ®
python main.py --skip-scrape

# é™é»˜æ¨¡å¼è¿è¡Œ
python main.py --quiet
python api_monitor.py --quiet

# å¼ºåˆ¶å‘é€é€šçŸ¥ï¼ˆå¿½ç•¥çŠ¶æ€å˜åŒ–æ£€æµ‹ï¼‰
python main.py --force-notify
python api_monitor.py --force-notify
```

### HTTP API ä½¿ç”¨

å¯åŠ¨æœåŠ¡å™¨åï¼Œå¯é€šè¿‡HTTP APIè¿œç¨‹æ§åˆ¶ç›‘æ§ï¼š

```bash
# ç®€å•URLè§¦å‘ï¼ˆæµè§ˆå™¨è®¿é—®æˆ–curlï¼‰
curl "http://localhost:8155/trigger/monitor_accounts?k=your_simple_key"
curl "http://localhost:8155/trigger/monitor_api_usage?k=your_simple_key"
curl "http://localhost:8155/trigger/full_monitor?k=your_simple_key"

# å¼ºåˆ¶å‘é€é€šçŸ¥
curl "http://localhost:8155/trigger/monitor_accounts?k=your_simple_key&f=true"

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
curl "http://localhost:8155/trigger/full_monitor/custom.yaml?k=your_simple_key"

# APIæ–‡æ¡£
http://localhost:8155/docs
```

## æ ¸å¿ƒæ¶æ„

### ç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ scrapers/           # æ•°æ®çˆ¬å–æ¨¡å—
â”‚   â”œâ”€â”€ claude_scraper.py   # Claudeè´¦æˆ·æ•°æ®çˆ¬å–
â”‚   â””â”€â”€ api_scraper.py      # APIä½¿ç”¨æ•°æ®çˆ¬å–
â”œâ”€â”€ monitors/           # ç›‘æ§åˆ†ææ¨¡å—
â”‚   â”œâ”€â”€ rate_limit_checker.py  # é™æµçŠ¶æ€æ£€æŸ¥
â”‚   â”œâ”€â”€ main.py             # Claudeè´¦æˆ·ç›‘æ§ç¼–æ’
â”‚   â””â”€â”€ api_monitor.py      # APIä½¿ç”¨ç›‘æ§ç¼–æ’
â”œâ”€â”€ notifiers/          # é€šçŸ¥å‘é€æ¨¡å—
â”‚   â”œâ”€â”€ feishu_notifier.py  # é£ä¹¦é€šçŸ¥ï¼ˆClaudeè´¦æˆ·ï¼‰
â”‚   â””â”€â”€ api_notifier.py     # é£ä¹¦é€šçŸ¥ï¼ˆAPIä½¿ç”¨ï¼‰
â”œâ”€â”€ server/             # HTTP APIæœåŠ¡
â”‚   â”œâ”€â”€ fastapi_server.py   # FastAPIæœåŠ¡å™¨
â”‚   â””â”€â”€ start_server.py     # æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â””â”€â”€ utils/              # å·¥å…·æ¨¡å—
    â””â”€â”€ config_loader.py    # é…ç½®æ–‡ä»¶åŠ è½½å™¨
```

### æ•°æ®æµ

- **Claudeè´¦æˆ·ç›‘æ§**: `ClaudeScraper` â†’ `RateLimitChecker` â†’ `FeishuNotifier`
- **APIä½¿ç”¨ç›‘æ§**: `ApiKeyScraper` â†’ `ApiNotifier`
- **HTTP API**: `Client` â†’ `FastAPI Server` â†’ `Internal Components` â†’ `Response`

### é…ç½®ç»“æ„

ç³»ç»Ÿä½¿ç”¨YAMLæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼š

- **api**: APIæ•°æ®æºé…ç½®ï¼ˆClaudeè´¦æˆ·ã€APIä½¿ç”¨ç«¯ç‚¹ï¼‰
- **storage**: æ•°æ®å­˜å‚¨é…ç½®ï¼ˆæ–‡ä»¶è·¯å¾„ã€ç›®å½•è®¾ç½®ï¼‰
- **notification**: é€šçŸ¥ç³»ç»Ÿé…ç½®ï¼ˆé£ä¹¦Webhook/åº”ç”¨æ¨¡å¼ã€æŒ‰é’®é…ç½®ï¼‰
- **server**: FastAPIæœåŠ¡å™¨é…ç½®ï¼ˆä¸»æœºã€ç«¯å£ã€è®¤è¯ï¼‰
- **system**: ç³»ç»Ÿé…ç½®ï¼ˆæ—¶åŒºç­‰ï¼‰

## é£ä¹¦é›†æˆè¯¦è§£

### é€šçŸ¥æ¨¡å¼

#### 1. Webhookæ¨¡å¼ï¼ˆç®€å•ï¼‰
- é…ç½®ï¼šä»…éœ€ `webhook_url`
- é™åˆ¶ï¼šåªæ”¯æŒURLè·³è½¬æŒ‰é’®
- é€‚ç”¨ï¼šå¿«é€Ÿéƒ¨ç½²ã€ç®€å•åœºæ™¯

#### 2. åº”ç”¨æ¨¡å¼ï¼ˆé«˜çº§ï¼‰
- é…ç½®ï¼šéœ€è¦ `app_id` å’Œ `app_secret`
- åŠŸèƒ½ï¼šæ”¯æŒå›è°ƒæŒ‰é’®ã€ChallengeéªŒè¯
- é€‚ç”¨ï¼šç”Ÿäº§ç¯å¢ƒã€äº¤äº’ä½“éªŒ

### æŒ‰é’®é…ç½®

æ”¯æŒä¸¤ç§æŒ‰é’®ç±»å‹ï¼š
- **URLè·³è½¬**: ç‚¹å‡»åè·³è½¬åˆ°æŒ‡å®šURLæ‰§è¡Œæ“ä½œ
- **å›è°ƒæ¨¡å¼**: ç‚¹å‡»åè§¦å‘é£ä¹¦å›è°ƒäº‹ä»¶ï¼ˆä»…åº”ç”¨æ¨¡å¼ï¼‰

### ChallengeéªŒè¯

å®Œæ•´æ”¯æŒé£ä¹¦ChallengeéªŒè¯æœºåˆ¶ï¼š
- **æ˜æ–‡æ¨¡å¼**: ç›´æ¥å¤„ç†JSONè¯·æ±‚
- **åŠ å¯†æ¨¡å¼**: AES-256-CBCè§£å¯†å¤„ç†
- **TokenéªŒè¯**: å¯é€‰çš„æ¥æºéªŒè¯

## é”™è¯¯å¤„ç†

ç³»ç»ŸåŒ…å«å¤šå±‚é”™è¯¯å¤„ç†ï¼š

### APIå±‚é¢
- **è®¤è¯é”™è¯¯**: Bearer tokenæ— æ•ˆæˆ–æƒé™ä¸è¶³
- **ç½‘ç»œé”™è¯¯**: è¿æ¥è¶…æ—¶ã€DNSè§£æå¤±è´¥
- **æ•°æ®æ ¼å¼**: APIå“åº”æ ¼å¼é”™è¯¯å¤„ç†

### é€šçŸ¥å±‚é¢
- **é£ä¹¦API**: Webhookå¤±è´¥æ—¶çš„é™çº§å¤„ç†
- **é…ç½®é”™è¯¯**: ç¼ºå°‘å¿…è¦é…ç½®æ—¶çš„å‹å¥½æç¤º

### ç³»ç»Ÿå±‚é¢
- **æ–‡ä»¶æ“ä½œ**: æ•°æ®ç›®å½•åˆ›å»ºã€æƒé™æ£€æŸ¥
- **è¿›ç¨‹ç®¡ç†**: ä¼˜é›…çš„å¼‚å¸¸é€€å‡ºå’Œèµ„æºæ¸…ç†

## éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
make install    # å®‰è£…ä¾èµ–
make run-dev    # å¼€å‘æ¨¡å¼å¯åŠ¨æœåŠ¡å™¨
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
make install
make server-prod  # å¤šè¿›ç¨‹ç”Ÿäº§æœåŠ¡å™¨
```

### å®šæ—¶ä»»åŠ¡
```bash
# crontab ç¤ºä¾‹
*/5 * * * * cd /path/to/project && make run >/dev/null 2>&1
```

## è®¸å¯è¯

MIT License
